# テスト駆動開発ルール

このルールは `rules/basic.md` に追加して適用されます。
中規模以上のプロジェクトで、品質保証とUI動作確認を確実に行うための追加ルールです。

## 1. テスト駆動開発（TDD）の必須化

### 1.1 TDDワークフロー

すべての新機能実装・バグ修正は以下のプロセスを厳守すること：

1. **テストファースト原則**
   - 実装コードを書く前に必ずテストを書く
   - テストファイル名: `.test.ts` または `.spec.ts`
   - テストを実行し、失敗することを確認してから実装に進む
2. **レッド・グリーン・リファクタサイクル**

   ```
   1. Red: 失敗するテストを書く
   2. Green: テストを通す最小限のコードを書く
   3. Refactor: コードを改善する（テストは通ったまま）

   ```

3. **各ステップでの出力表示**
   - テスト実行結果は必ずコンソール出力を表示する
   - 「テストが通った」という報告だけでなく、実際の出力を見せる

### 1.2 完了条件

タスクを「完了」と報告する前に、以下をすべて満たすこと：

```bash
# 必須チェック項目
- [ ] npm test（すべてのテストが通過）
- [ ] npm run lint（エラー・警告なし）
- [ ] npm run typecheck（型エラーなし）
- [ ] npm run test:e2e（E2Eテストが通過）※該当する場合
- [ ] UI検証完了（下記参照）

```

## 2. UI実装の視覚的検証

### 2.1 Playwright MCPサーバーの活用

UI変更を伴うすべてのタスクで以下を実行：

1. **実装前のベースライン取得**

   ```jsx
   await page.screenshot({ path: 'before-implementation.png', fullPage: true });
   ```

2. **実装後の確認**

   ```jsx
   await page.screenshot({ path: 'after-implementation.png', fullPage: true });
   // 差分を確認して報告
   ```

3. **レスポンシブ確認**

   ```jsx
   // デスクトップ、タブレット、モバイルの3サイズで確認
   const viewports = [
     { width: 1920, height: 1080, name: 'desktop' },
     { width: 768, height: 1024, name: 'tablet' },
     { width: 375, height: 667, name: 'mobile' },
   ];
   ```

### 2.2 インタラクション検証

1. **クリック可能要素のテスト**
   - すべてのボタン、リンクが実際にクリック可能か確認
   - クリック後の動作が期待通りか検証
2. **フォーム動作確認**
   - 入力フィールドへの文字入力
   - バリデーションエラーの表示
   - 送信処理の動作
3. **アニメーション・トランジション**
   - 動作の録画またはGIF作成
   - タイミングとスムーズさの確認

### 2.3 実ブラウザでの手動確認

```jsx
// 開発サーバーを起動した状態で
await page.pause(); // デバッグモードで一時停止
// 手動で以下を確認：
// - 意図した通りの見た目か
// - インタラクションが正しく動作するか
// - コンソールエラーが出ていないか
```

## 3. テストの種類と必須範囲

### 3.1 必須テストカバレッジ

- **ユニットテスト**: すべてのビジネスロジック関数
- **コンポーネントテスト**: すべてのUIコンポーネント
- **統合テスト**: API連携、状態管理
- **E2Eテスト**: 主要なユーザーフロー

### 3.2 エッジケースの考慮

必ず以下のケースをテストに含める：

- 空データ、null、undefined
- 境界値（最大値、最小値）
- エラー状態
- 非同期処理のタイムアウト
- 同時実行・競合状態

## 4. GitHub Issue連携

### 4.1 Issue内のTDD要件

各Issueには以下のセクションを含めること：

```markdown
## TDD要件

- [ ] テストファイル: `src/__tests__/feature.test.ts`
- [ ] 最低限のテストケース:
  - [ ] 正常系の動作
  - [ ] 異常系のエラーハンドリング
  - [ ] エッジケース
- [ ] UI検証が必要な場合はスクリーンショット添付
```

### 4.2 進捗報告フォーマット

```markdown
## テスト実装状況

1. ✅ 認証テスト作成完了（5件）
   - 実行結果: [テスト出力をここに貼る]
2. 🔄 UIコンポーネントテスト作成中
3. ⏳ E2Eテスト未着手

## UI検証結果

- Desktop: [スクリーンショット]
- Mobile: [スクリーンショット]
- 動作確認GIF: [添付]
```

## 5. 問題発生時の対応

### 5.1 テストが通らない場合

1. エラーメッセージを完全に表示
2. 関連するコードを確認
3. 5回試行しても解決しない場合は、具体的な対策案と共にユーザーに相談

### 5.2 UIが意図通りに動作しない場合

1. スクリーンショットまたは動画で問題を記録
2. 期待される動作と実際の動作の差異を明確に説明
3. DOMインスペクションで要素の状態を確認
4. 修正後、必ず再度すべての検証を実行

## 6. 禁止事項

- ❌ テストを書かずに実装を開始すること
- ❌ テストの実行をスキップして「通った」と報告すること
- ❌ UI変更時に視覚的確認を省略すること
- ❌ 既存のテストを壊したまま新機能を追加すること
- ❌ エラーが出ているのに「ほぼ完成」と報告すること

## 7. 推奨ツール設定

```json
// .vscode/settings.json に追加
{
  "jest.autoRun": {
    "watch": true,
    "onSave": "test-file"
  },
  "typescript.tsdk": "node_modules/typescript/lib",
  "editor.formatOnSave": true
}
```
